(async function () {

  const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  async function waitForElement(selector, timeout = 10000) {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      const el = document.querySelector(selector);
      if (el) return el;
      await delay(300);
    }
    return null;
  }

  // ==== PILIH FILE CSV ====
  const inputFile = document.createElement("input");
  inputFile.type = "file";
  inputFile.accept = ".csv";
  inputFile.click();

  inputFile.onchange = async function () {

    const file = inputFile.files[0];
    if (!file) return alert("File tidak dipilih");

    const text = await file.text();

    // ==== PARSE CSV (2 KOLOM: idsbr;hasil) ====
    const lines = text.split(/\r?\n/).map(r => r.trim()).filter(r => r !== "");

    if (lines.length < 2) {
      return alert("Format CSV salah. Minimal ada header dan 1 data.");
    }

    const header = lines[0].toLowerCase().trim();

    if (header !== "idsbr;hasil") {
      return alert("Header harus tepat: idsbr;hasil");
    }

    const rows = lines.slice(1).map(line => {
      const parts = line.split(";").map(v => v.trim());
      return {
        idsbr: parts[0],
        hasil: parts[1]
      };
    });

    console.log("Total data ditemukan:", rows.length);

    // ==== LOOP SETIAP RECORD ====
    for (let i = 0; i < rows.length; i++) {

      const currentID = rows[i].idsbr;
      const currentHasil = rows[i].hasil;

      console.log(`Proses (${i+1}/${rows.length}) : ${currentID} -> hasil: ${currentHasil}`);

      // 1. Isi IDSBR
      const searchInput = document.getElementById("search-idsbr");
      if (!searchInput) {
        console.log("search-idsbr tidak ditemukan");
        return;
      }

      searchInput.value = currentID;
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      searchInput.dispatchEvent(new Event('change', { bubbles: true }));

      await delay(1500);

      // 2. Klik container usaha
      const usahaContainer = document.getElementById("usaha-cards-container");
      if (usahaContainer) usahaContainer.click();

      await delay(1500);

      // 3. Klik tombol tandai
      const btnTandai = await waitForElement(".btn-tandai");
      if (!btnTandai) {
        console.log("btn-tandai tidak ditemukan, skip...");
        continue;
      }
      btnTandai.click();

      await delay(1500);

      // 4. Set nilai sesuai kolom hasil
      const hasilGc = document.getElementById("tt_hasil_gc");
      if (hasilGc) {
        hasilGc.value = currentHasil;
        hasilGc.dispatchEvent(new Event('input', { bubbles: true }));
        hasilGc.dispatchEvent(new Event('change', { bubbles: true }));
      }

      await delay(1000);

      // 5. Klik save
      const saveBtn = document.getElementById("save-tandai-usaha-btn");
      if (saveBtn) saveBtn.click();

      await delay(1500);

      // 6. Klik semua SweetAlert confirm
      for (let j = 0; j < 3; j++) {
        const confirmBtn = await waitForElement(".swal2-confirm.swal2-styled", 5000);
        if (confirmBtn) {
          confirmBtn.click();
          await delay(1500);
        } else {
          break;
        }
      }

      await delay(2000); // jeda antar ID
    }

    alert("Selesai semua record âœ…");

  };

})();
