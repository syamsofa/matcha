(async function () {

  const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  // ==== FUNCTION WAIT ELEMENT ====
  async function waitForElement(selector, timeout = 10000) {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      const el = document.querySelector(selector);
      if (el) return el;
      await delay(300);
    }
    return null;
  }

  // ==== PILIH FILE CSV ====
  const inputFile = document.createElement("input");
  inputFile.type = "file";
  inputFile.accept = ".csv";
  inputFile.click();

  inputFile.onchange = async function () {

    const file = inputFile.files[0];
    if (!file) return alert("File tidak dipilih");

    const text = await file.text();

    // Pisahkan baris, buang header jika ada
    let rows = text.split(/\r?\n/).map(r => r.trim()).filter(r => r !== "");

    console.log("Total ID ditemukan:", rows.length);

    // ==== LOOP SETIAP RECORD ====
    for (let i = 0; i < rows.length; i++) {

      const currentID = rows[i];
      console.log(`Proses (${i+1}/${rows.length}) : ${currentID}`);

      // 1. Isi ID
      const searchInput = document.getElementById("search-idsbr");
      if (!searchInput) return console.log("search-idsbr tidak ditemukan");

      searchInput.value = currentID;
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      searchInput.dispatchEvent(new Event('change', { bubbles: true }));

      await delay(1500);

      // 2. Klik container usaha
      const usahaContainer = document.getElementById("usaha-cards-container");
      if (usahaContainer) usahaContainer.click();

      await delay(1500);

      // 3. Klik tombol tandai
      const btnTandai = await waitForElement(".btn-tandai");
      if (!btnTandai) {
        console.log("btn-tandai tidak ditemukan, skip...");
        continue;
      }
      btnTandai.click();

      await delay(1500);

      // 4. Set nilai 3
      const hasilGc = document.getElementById("tt_hasil_gc");
      if (hasilGc) {
        hasilGc.value = "3";
        hasilGc.dispatchEvent(new Event('input', { bubbles: true }));
        hasilGc.dispatchEvent(new Event('change', { bubbles: true }));
      }

      await delay(1000);

      // 5. Klik save
      const saveBtn = document.getElementById("save-tandai-usaha-btn");
      if (saveBtn) saveBtn.click();

      await delay(1500);

      // 6. Klik semua SweetAlert confirm yang muncul
      for (let j = 0; j < 3; j++) {
        const confirmBtn = await waitForElement(".swal2-confirm.swal2-styled", 5000);
        if (confirmBtn) {
          confirmBtn.click();
          await delay(1500);
        } else {
          break;
        }
      }

      await delay(2000); // jeda sebelum lanjut ID berikutnya
    }

    alert("Selesai semua record âœ…");

  };

})();
